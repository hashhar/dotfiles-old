#!/bin/bash

if [ $# -lt 2 ]; then
	cat << EOF
Usage: iterate_all cmd infile [logfile]
Runs the script or command 'cmd' on all paths mentioned in 'infile' and optionally writes the paths processed to 'logfile'.
EOF
exit 1
fi

if [ "x$3" != "x" ]; then
	>"$3"
fi

OIFS=$IFS
IFS=$(echo -en "\n\b")
while read -r line || [[ -n "$line" ]]; do
	cd "$line"
	echo "######### $line #########"
	if [ "x$3" != "x" ]; then
		echo "$line" >> "$3"
		sh -c "$1" 1>>"$3" 2>&1
		ret=$?
	else
		echo "$line" >> "$3"
		sh -c "$1"
		ret=$?
	fi
	if [ $ret -ne 0 ]; then
		echo "$line" >> "$3.errors"
	fi
done < "$2"
IFS=$OIFS
